<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Level 3</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #0a0a0a; color: #e0e0e0; height: 100vh; display: flex; flex-direction: column; }
  #messages { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem; }
  .msg { max-width: 80%; padding: 0.75rem 1rem; border-radius: 0.75rem; line-height: 1.5; white-space: pre-wrap; word-wrap: break-word; }
  .msg.user { align-self: flex-end; background: #2563eb; color: white; }
  .msg.assistant { align-self: flex-start; background: #1e1e1e; }
  .msg.tool { align-self: flex-start; background: #1a1a2e; font-family: monospace; font-size: 0.8rem; color: #888; cursor: pointer; max-height: 2.5rem; overflow: hidden; transition: max-height 0.2s; }
  .msg.tool.expanded { max-height: none; }
  .msg.error { align-self: flex-start; background: #2d1111; color: #ef4444; }
  #input-area { display: flex; padding: 1rem; gap: 0.5rem; border-top: 1px solid #222; }
  #input { flex: 1; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid #333; background: #111; color: #e0e0e0; font-size: 1rem; outline: none; }
  #input:focus { border-color: #2563eb; }
  #send { padding: 0.75rem 1.5rem; border-radius: 0.5rem; border: none; background: #2563eb; color: white; font-size: 1rem; cursor: pointer; }
  #send:hover { background: #1d4ed8; }
  #send:disabled { opacity: 0.5; cursor: not-allowed; }
  #status { align-self: flex-start; padding: 0.5rem 1rem; color: #666; font-size: 0.85rem; display: none; }
  #status.visible { display: flex; align-items: center; gap: 0.5rem; }
  @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
  #status .dot { width: 6px; height: 6px; background: #2563eb; border-radius: 50%; animation: pulse 1.2s ease-in-out infinite; }
  #status .dot:nth-child(2) { animation-delay: 0.2s; }
  #status .dot:nth-child(3) { animation-delay: 0.4s; }
</style>
</head>
<body>
<div id="messages">
  <div id="status">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
    <span id="status-text">Thinking...</span>
  </div>
</div>
<div id="input-area">
  <input id="input" type="text" placeholder="Say something..." autocomplete="off" />
  <button id="send">Send</button>
</div>
<script>
const messages = document.getElementById('messages');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send');
const status = document.getElementById('status');
const statusText = document.getElementById('status-text');

let ws = null;
let waiting = false;

function setStatus(text) {
  if (text) {
    statusText.textContent = text;
    status.classList.add('visible');
  } else {
    status.classList.remove('visible');
  }
  messages.scrollTop = messages.scrollHeight;
}

function connect() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/chat`);

  ws.onopen = () => {
    sendBtn.disabled = false;
  };

  ws.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.type === 'tool_call') {
      setStatus(`Running ${data.name}...`);
    } else if (data.type === 'tool_result') {
      setStatus('Thinking...');
    }

    renderMessage(data);

    if (data.type === 'assistant' || data.type === 'error') {
      setStatus(null);
      waiting = false;
      sendBtn.disabled = false;
      input.focus();
    }
  };

  ws.onclose = () => {
    sendBtn.disabled = true;
    setStatus(null);
    setTimeout(connect, 2000);
  };
}

function send() {
  const text = input.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN || waiting) return;

  const div = document.createElement('div');
  div.classList.add('msg', 'user');
  div.textContent = text;
  messages.insertBefore(div, status);

  ws.send(JSON.stringify({ type: 'message', content: text }));
  input.value = '';
  waiting = true;
  sendBtn.disabled = true;
  setStatus('Thinking...');
}

function renderMessage(data) {
  const div = document.createElement('div');
  div.classList.add('msg', data.type === 'tool_call' || data.type === 'tool_result' ? 'tool' : data.type);

  if (data.type === 'tool_call') {
    div.textContent = `[${data.name}] ${JSON.stringify(data.arguments)}`;
    div.onclick = () => div.classList.toggle('expanded');
  } else if (data.type === 'tool_result') {
    div.textContent = `[${data.name} result] ${data.content}`;
    div.onclick = () => div.classList.toggle('expanded');
  } else {
    div.textContent = data.content;
  }

  messages.insertBefore(div, status);
  messages.scrollTop = messages.scrollHeight;
}

async function loadHistory() {
  try {
    const res = await fetch('/api/history');
    const events = await res.json();
    for (const event of events) {
      renderMessage(event);
    }
  } catch (e) {
    // History unavailable â€” not critical
  }
}

sendBtn.onclick = send;
input.onkeydown = (e) => { if (e.key === 'Enter') send(); };

loadHistory();
connect();
</script>
</body>
</html>
